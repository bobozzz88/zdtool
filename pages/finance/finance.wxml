<view class="container">
  <!-- é¡¶éƒ¨å›ºå®šåŒºåŸŸ -->
  <view class="fixed-header">
    <!-- æœˆä»½é€‰æ‹©å™¨ -->
    <view class="month-selector">
      <text class="arrow" bindtap="previousMonth">â—€</text>
      <text class="month-text">{{currentYear}}å¹´{{currentMonth}}æœˆ</text>
      <text class="arrow" bindtap="nextMonth">â–¶</text>
    </view>
    
    <!-- è®°è´¦æŒ‰é’® -->
    <view class="add-btn" bindtap="addRecord">
      <text class="icon">ğŸ“</text>
    </view>
  </view>

  <!-- å¯æ»šåŠ¨åŒºåŸŸ -->
  <scroll-view 
    class="scrollable-content" 
    scroll-y="true"
    refresher-enabled="{{true}}"
    refresher-triggered="{{isRefreshing}}"
    bindrefresherrefresh="onRefresh"
    bindscrolltolower="onLoadMore">
    
    <!-- æœˆåº¦ç»Ÿè®¡å¡ç‰‡ -->
    <view class="overview-card">
      <view class="amount-row">
        <view class="amount-item">
          <text class="label">æœ¬æœˆæ”¯å‡º</text>
          <text class="value expense">Â¥{{monthlyExpense}}</text>
        </view>
        <view class="amount-item">
          <text class="label">æœ¬æœˆæ”¶å…¥</text>
          <text class="value income">Â¥{{monthlyIncome}}</text>
        </view>
      </view>
      <view class="amount-row">
        <view class="amount-item">
          <text class="label">é¢„ç®—å‰©ä½™</text>
          <text class="value">Â¥{{monthlyBudget - monthlyExpense}}</text>
        </view>
        <view class="amount-item">
          <text class="label">ç»“ä½™</text>
          <text class="value {{monthlyBalance >= 0 ? 'income' : 'expense'}}">Â¥{{monthlyBalance}}</text>
        </view>
      </view>
    </view>

    <!-- é¢„ç®—è¿›åº¦å¡ç‰‡ -->
    <view class="budget-card">
      <view class="card-header">
        <text class="card-title">æœ¬æœˆé¢„ç®—</text>
        <text class="action-text" bindtap="manageBudget">è®¾ç½®</text>
      </view>
      <view class="budget-content">
        <view class="budget-info">
          <text>å·²ç”¨ Â¥{{monthlyExpense}}</text>
          <text>æ€»é¢„ç®— Â¥{{monthlyBudget}}</text>
        </view>
        <view class="progress-container">
          <progress 
            percent="{{budgetProgress}}" 
            stroke-width="12" 
            color="{{budgetProgress > 80 ? '#ff4d4f' : (budgetProgress > 50 ? '#faad14' : '#52c41a')}}"
            active active-mode="forwards"/>
          <text class="budget-percentage {{budgetProgress > 80 ? 'danger' : (budgetProgress > 50 ? 'warning' : 'normal')}}">
            {{budgetProgress}}%
          </text>
        </view>
        
        <!-- åˆ†ç±»é¢„ç®—å±•ç¤º -->
        <view class="category-budget-list" wx:if="{{budgetCategories && budgetCategories.length > 0}}">
          <view class="category-budget-title">åˆ†ç±»é¢„ç®—ä½¿ç”¨æƒ…å†µ</view>
          <view class="category-budget-row" wx:for="{{budgetCategories}}" wx:key="name" wx:if="{{item.budget > 0}}">
            <view class="category-budget-info">
              <text class="category-icon">{{item.icon}}</text>
              <text class="category-name">{{item.name}}</text>
              <text class="category-amount">Â¥{{item.used || 0}}/Â¥{{item.budget}}</text>
            </view>
            <view class="category-progress-container">
              <progress 
                percent="{{item.progress || 0}}" 
                stroke-width="8" 
                color="{{item.progress > 80 ? '#ff4d4f' : (item.progress > 50 ? '#faad14' : '#52c41a')}}"
                active active-mode="forwards"/>
            </view>
          </view>
          <view class="no-category-budget" wx:if="{{!hasCategoryBudgets}}">
            <text>æš‚æ— åˆ†ç±»é¢„ç®—ï¼Œç‚¹å‡»"è®¾ç½®"æ·»åŠ </text>
          </view>
        </view>
      </view>
    </view>

    <!-- è´¦å•æ˜ç»† -->
    <view class="records-card">
      <view class="card-header">
        <text class="card-title">è´¦å•æ˜ç»†</text>
        <view class="header-actions">
          <text class="action-text" bindtap="showFilter">ç­›é€‰</text>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{!records || records.length === 0}}">
        <image class="empty-icon" src="/images/empty.png" mode="aspectFit"></image>
        <text class="empty-text">æš‚æ— è´¦å•è®°å½•</text>
        <text class="empty-desc">ç‚¹å‡»å³ä¸Šè§’"+"æ·»åŠ ä¸€ç¬”æ–°è´¦å•</text>
      </view>

      <!-- è´¦å•åˆ—è¡¨ -->
      <view class="records-list" wx:else>
        <block wx:for="{{records}}" wx:key="date">
          <view class="date-group">
            <view class="date-header">
              <text class="date">{{item.date}}</text>
              <view class="date-summary">
                <block wx:if="{{item.totalExpense > 0}}">
                  <text class="expense">æ”¯å‡º Â¥{{item.totalExpense}}</text>
                </block>
                <block wx:if="{{item.totalIncome > 0}}">
                  <text class="income">æ”¶å…¥ Â¥{{item.totalIncome}}</text>
                </block>
              </view>
            </view>
            
            <view class="records-group">
              <movable-area class="record-item-wrap" 
                           wx:for="{{item.items}}" 
                           wx:key="id" 
                           wx:for-item="record">
                <movable-view direction="horizontal" 
                             class="record-item"
                             bindtap="viewRecord" 
                             data-id="{{record.id}}"
                             out-of-bounds="{{true}}"
                             damping="20"
                             friction="2"
                             x="{{0}}">
                  <view class="record-icon">{{record.icon}}</view>
                  <view class="record-content">
                    <view class="record-category">{{record.category}}</view>
                    <view class="record-note" wx:if="{{record.note}}">{{record.note}}</view>
                  </view>
                  <view class="record-amount {{record.type === 'expense' ? 'expense' : 'income'}}">
                    {{record.type === 'expense' ? '-' : '+'}}Â¥{{record.amount}}
                  </view>
                </movable-view>
                <view class="record-item-del" bindtap="deleteRecord" data-id="{{record.id}}">
                  åˆ é™¤
                </view>
              </movable-area>
            </view>
          </view>
        </block>
      </view>
    </view>
    
    <!-- åŠ è½½æ›´å¤š -->
    <view class="loading-more" wx:if="{{hasMore}}">
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
    
    <!-- æ²¡æœ‰æ›´å¤šæ•°æ® -->
    <view class="no-more" wx:elif="{{records.length > 0}}">
      <text class="no-more-text">æ²¡æœ‰æ›´å¤šæ•°æ®äº†</text>
    </view>
  </scroll-view>

  <!-- è®°è´¦å¼¹çª— -->
  <view class="modal {{showRecordModal ? 'show' : ''}}" catchtouchmove="true">
    <view class="modal-mask" bindtap="hideRecordModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">è®°ä¸€ç¬”</text>
        <text class="close" bindtap="hideRecordModal">Ã—</text>
      </view>
      <view class="modal-body">
        <view class="type-selector">
          <view class="type-btn {{recordType === 'expense' ? 'active' : ''}}" 
                bindtap="selectType" data-type="expense">æ”¯å‡º</view>
          <view class="type-btn {{recordType === 'income' ? 'active' : ''}}" 
                bindtap="selectType" data-type="income">æ”¶å…¥</view>
        </view>
        
        <view class="form-item">
          <input type="digit" class="amount-input" 
                 placeholder="è¯·è¾“å…¥é‡‘é¢" 
                 value="{{newRecord.amount}}"
                 bindinput="inputAmount"/>
        </view>

        <view class="category-grid">
          <block wx:for="{{recordType === 'expense' ? expenseCategories : incomeCategories}}" 
                 wx:key="name">
            <view class="category-btn {{newRecord.category === item.name ? 'active' : ''}}"
                  bindtap="selectCategory" 
                  data-category="{{item.name}}" 
                  data-icon="{{item.icon}}">
              <text class="icon">{{item.icon}}</text>
              <text>{{item.name}}</text>
            </view>
          </block>
        </view>

        <view class="form-item">
          <input class="note-input" 
                 placeholder="æ·»åŠ å¤‡æ³¨" 
                 value="{{newRecord.note}}"
                 bindinput="inputNote"/>
        </view>

        <view class="form-item">
          <picker mode="date" value="{{newRecord.date}}" bindchange="dateChange">
            <view class="picker">
              <text class="label">æ—¥æœŸ</text>
              <text>{{newRecord.date || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</text>
            </view>
          </picker>
        </view>

        <view class="upload-section">
          <view class="upload-btn" bindtap="uploadReceipt">
            <text class="icon">ğŸ“·</text>
            <text>ä¸Šä¼ ç¥¨æ®</text>
          </view>
          <!-- æ˜¾ç¤ºå·²ä¸Šä¼ çš„ç¥¨æ®å›¾ç‰‡ -->
          <view class="uploaded-receipts" wx:if="{{newRecord.receiptImages.length > 0}}">
            <view class="receipt-item" wx:for="{{newRecord.receiptImages}}" wx:key="*this">
              <image 
                class="receipt-thumbnail" 
                src="{{item}}" 
                mode="aspectFill"
                data-index="{{index}}"
                bindtap="previewUploadedReceipt"></image>
              <text class="remove-receipt" 
                    data-index="{{index}}"
                    bindtap="removeUploadedReceipt">Ã—</text>
            </view>
          </view>
        </view>

        <button class="submit-btn" bindtap="saveRecord">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- é¢„ç®—è®¾ç½®å¼¹çª— -->
  <view class="modal {{showBudgetModal ? 'show' : ''}}" catchtouchmove="true">
    <view class="modal-mask" bindtap="hideBudgetModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">é¢„ç®—è®¾ç½®</text>
        <text class="close" bindtap="hideBudgetModal">Ã—</text>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="label">æœˆåº¦æ€»é¢„ç®—</text>
          <input type="digit" class="budget-input" 
                 placeholder="è¯·è¾“å…¥é¢„ç®—é‡‘é¢" 
                 value="{{newBudget}}"
                 bindinput="inputBudget"/>
        </view>

        <view class="category-budgets">
          <text class="subtitle">åˆ†ç±»é¢„ç®—</text>
          <block wx:for="{{budgetCategories}}" wx:key="name" wx:for-index="idx">
            <view class="category-budget-item">
              <view class="category-info">
                <text class="icon">{{item.icon}}</text>
                <text>{{item.name}}</text>
              </view>
              <input type="digit" class="category-budget-input" 
                     placeholder="é¢„ç®—é‡‘é¢" 
                     value="{{item.budget}}"
                     bindinput="inputCategoryBudget"
                     data-index="{{idx}}"/>
            </view>
          </block>
        </view>

        <button class="submit-btn" bindtap="saveBudget">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å¼¹çª— -->
  <view class="modal {{showFilterModal ? 'show' : ''}}" catchtouchmove="true">
    <view class="modal-mask" bindtap="hideFilterModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ç­›é€‰</text>
        <text class="close" bindtap="hideFilterModal">Ã—</text>
      </view>
      <view class="modal-body">
        <view class="filter-type">
          <text class="subtitle">ç±»å‹</text>
          <view class="filter-type-btns">
            <view class="filter-type-btn {{filter.type === 'all' ? 'active' : ''}}" 
                  bindtap="selectFilterType" data-type="all">å…¨éƒ¨</view>
            <view class="filter-type-btn {{filter.type === 'expense' ? 'active' : ''}}" 
                  bindtap="selectFilterType" data-type="expense">æ”¯å‡º</view>
            <view class="filter-type-btn {{filter.type === 'income' ? 'active' : ''}}" 
                  bindtap="selectFilterType" data-type="income">æ”¶å…¥</view>
          </view>
        </view>

        <view class="filter-date">
          <text class="subtitle">æ—¥æœŸèŒƒå›´</text>
          <view class="date-range">
            <picker mode="date" value="{{filter.startDate}}" bindchange="startDateChange">
              <view class="date-picker">
                <text>{{filter.startDate || 'å¼€å§‹æ—¥æœŸ'}}</text>
              </view>
            </picker>
            <text class="date-separator">è‡³</text>
            <picker mode="date" value="{{filter.endDate}}" bindchange="endDateChange">
              <view class="date-picker">
                <text>{{filter.endDate || 'ç»“æŸæ—¥æœŸ'}}</text>
              </view>
            </picker>
          </view>
        </view>

        <view class="filter-amount">
          <text class="subtitle">é‡‘é¢èŒƒå›´</text>
          <view class="amount-range">
            <input type="digit" class="amount-input" 
                   placeholder="æœ€å°é‡‘é¢" 
                   value="{{filter.minAmount}}"
                   bindinput="inputMinAmount"/>
            <text class="amount-separator">è‡³</text>
            <input type="digit" class="amount-input" 
                   placeholder="æœ€å¤§é‡‘é¢" 
                   value="{{filter.maxAmount}}"
                   bindinput="inputMaxAmount"/>
          </view>
        </view>

        <view class="filter-actions">
          <button class="reset-btn" bindtap="resetFilter">é‡ç½®</button>
          <button class="apply-btn" bindtap="applyFilter">åº”ç”¨</button>
        </view>
      </view>
    </view>
  </view>

  <!-- è®°å½•è¯¦æƒ…å¼¹çª— -->
  <view class="modal {{showRecordDetailModal ? 'show' : ''}}" catchtouchmove="true">
    <view class="modal-mask" bindtap="hideRecordDetail"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">è´¦å•è¯¦æƒ…</text>
        <text class="close" bindtap="hideRecordDetail">Ã—</text>
      </view>
      <view class="modal-body">
        <view class="record-detail">
          <view class="record-detail-header">
            <view class="record-detail-icon">{{currentRecord.icon}}</view>
            <view class="record-detail-type {{currentRecord.type === 'expense' ? 'expense' : 'income'}}">
              {{currentRecord.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'}}
            </view>
          </view>
          
          <view class="record-detail-amount {{currentRecord.type === 'expense' ? 'expense' : 'income'}}">
            {{currentRecord.type === 'expense' ? '-' : '+'}}Â¥{{currentRecord.amount}}
          </view>
          
          <view class="record-detail-info">
            <view class="detail-item">
              <text class="detail-label">åˆ†ç±»</text>
              <text class="detail-value">{{currentRecord.category}}</text>
            </view>
            
            <view class="detail-item">
              <text class="detail-label">æ—¥æœŸ</text>
              <text class="detail-value">{{currentRecord.date}}</text>
            </view>
            
            <view class="detail-item" wx:if="{{currentRecord.note}}">
              <text class="detail-label">å¤‡æ³¨</text>
              <text class="detail-value">{{currentRecord.note}}</text>
            </view>
            
            <view class="detail-item">
              <text class="detail-label">åˆ›å»ºæ—¶é—´</text>
              <text class="detail-value">{{currentRecord.createTimeFormatted}}</text>
            </view>
          </view>
          
          <!-- æ·»åŠ ç¥¨æ®å›¾ç‰‡æ˜¾ç¤º -->
          <view class="receipt-image-container" wx:if="{{currentRecord.receiptImages.length > 0}}">
            <text class="receipt-title">ç¥¨æ®å›¾ç‰‡</text>
            <view class="receipt-grid">
              <view class="receipt-item" wx:for="{{currentRecord.receiptImages}}" wx:key="*this">
                <image 
                  class="receipt-image" 
                  src="{{item}}" 
                  mode="aspectFill"
                  data-index="{{index}}"
                  bindtap="viewReceiptImage"></image>
              </view>
            </view>
          </view>
          
          <view class="record-detail-actions">
            <button class="detail-action-btn edit" bindtap="editRecord">ç¼–è¾‘</button>
            <button class="detail-action-btn delete" bindtap="deleteRecordFromDetail">åˆ é™¤</button>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>